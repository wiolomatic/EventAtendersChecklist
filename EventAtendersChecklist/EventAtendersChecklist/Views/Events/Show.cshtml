@model EventAtendersChecklist.ModelsView.ListOfAttendeesWithActions

@using GridMvc.Html;

@{
    ViewBag.Title = "Show list";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div>
    <h4>Show event list</h4>
    <hr />
    @if (User.Identity.IsAuthenticated)
    {
        if (User.IsInRole("HR"))
        {
            <p>
                @Html.ActionLink("Add New Attendee", "AddToEvent", "Employees", new { id = Model.EventId }, new { @class = "btn btn-success" })
                @Html.ActionLink("Add New Action", "AddActionToEvent", "ActionDictionaries", new { id = Model.EventId }, new { @class = "btn btn-success" })
                @Html.ActionLink("Import from excel", "ImportExcelFile", "Events", new { id = Model.EventId }, new { @class = "btn btn-success" })
                @if (Model != null)
                {
                    @Html.ActionLink("Export to excel", "ExportToExcel", "Events", new { id = Model.EventId }, new { @class = "btn btn-primary pull-right" })
                }
            </p>
        }
    }
</div>

@Html.Grid(Model.EventAttenderList).Columns(columns =>
{
    columns.Add()
        .Encoded(false)
        .Sanitized(false)
        .RenderValueAs(o => @<button class="btn-danger glyphicon glyphicon-trash" 
                                     data-toggle="modal" data-target="#MyModal" 
                                     onclick="ConfirmDelete(@Model.EventId, @o.AttenderId)"></button>);
    columns.Add(x => x.FirstName).Titled("First Name").Sortable(true);
    columns.Add(x => x.LastName).Titled("Last Name").Sortable(true);
    columns.Add(x => x.Email).Titled("Email").Sortable(true);
    foreach (var item in Model.ActionDictionaryList)
    {
        columns.Add()
        .Titled(item.Name)
        .Encoded(false)
        .Sanitized(false)
        .RenderValueAs(o => Html.CheckBox(string.Format("checkbox|{0}|{1}|{2}",Model.EventId, o.AttenderId, item.Id), o.Actions
                        .Where(x => x.ActionId == item.Id)
                        .Select(x => x.Value).First(), new { @onclick="AsertClick(this.id)" }))
            .Sortable(true);
    }
}).WithPaging(10).WithMultipleFilters()
<p>
   @Html.ActionLink("Back to List", "Index", null, new { @class = "btn btn-primary" })
</p>

<input type="hidden" id="hiddenEmployeeId" />
<input type="hidden" id="hiddenEventId" />

<div class="modal fade" id="MyModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-header">Delete Attendee</h3>
            </div>
            <div class="modal-body">
                <h4>Are you sure? You want to delete this.</h4>
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-default" data-dismiss="modal">Cancle</a>
                <a href="#" class="btn btn-danger" onclick="DeleteEmployee()">Delete</a>
            </div>
        </div>
    </div>
</div>
<script>
    var ConfirmDelete = function (EventId, employeeId)
    {
        $("#hiddenEmployeeId").val(employeeId);
        $("#hiddenEventId").val(EventId);

        $("MyModal").modal('Show');        
    }

    var DeleteEmployee = function () {
        var empId = $("#hiddenEmployeeId").val();
        var eventId = $("#hiddenEventId").val();

        $.ajax({
            type: "POST",
            url: "/Events/DeleteEmployee",
            data: {
                EmployeeId: empId,
                EventId: eventId
            },
            success: function (result) {
                $("#MyModal").hide();
                location.reload();
            }
        })
    }

    function AsertClick(clicked_id) {
        var val = document.getElementById(clicked_id).checked;
        var res = clicked_id.split("_");
        var EventId = String(res[1]);
        var AttendeeId = String(res[2]);
        var ActionId = String(res[3]);
        $.ajax({
            type: "POST",
            url: "/Events/ChangeCheckBoxValue",
            data: {
                EmployeeId: AttendeeId,
                EventId: EventId,
                ActionID: ActionId,
                value : val
            },
            success: function (result) {
                location.reload();
            }
        })
    }

</script>